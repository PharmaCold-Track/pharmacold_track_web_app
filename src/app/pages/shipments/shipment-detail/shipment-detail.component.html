<div class="detail-container" *ngIf="shipment() as data">
  <header class="detail-header">
    <div class="header-left">
      <a routerLink="/shipments" class="back-link">â† Volver</a>
      <h1>EnvÃ­o #{{ data.id }}</h1>
      <span class="status-pill" [ngClass]="data.status">{{ data.status.replace('_', ' ') }}</span>
    </div>

    <div class="header-right" *ngIf="!isActionLoading(); else loadingAction">
      <button class="btn-action departure" *ngIf="data.status === 'CREATED'" (click)="onDeparture()">
        <i class="fas fa-truck-moving"></i> Registrar Salida
      </button>

      <button class="btn-action delivery" *ngIf="data.status === 'IN_TRANSIT'" (click)="openDeliveryModal()">
        <i class="fas fa-clipboard-check"></i> Registrar Entrega
      </button>
    </div>

    <ng-template #loadingAction>
      <div class="spinner-small"></div>
    </ng-template>
  </header>

  <div class="dashboard-grid">
    <div class="card temp-card">
      <h3>Temperatura Actual</h3>
      <div class="big-temp" [style.color]="getTempColor(data.currentTemp || 0)">
        {{ data.currentTemp !== null ? data.currentTemp + 'Â°C' : '--' }}
      </div>
      <p class="last-update">Ãšltima lectura del sensor</p>
    </div>

    <div class="card map-card">
      <h3>Ruta en Tiempo Real</h3>
      <div class="map-frame">

        <google-map
          *ngIf="apiLoaded()"
          height="100%"
          width="100%"
          [center]="centerPosition"
          [options]="mapOptions"
        >
          <map-polyline
            [path]="routePath"
            [options]="{ strokeColor: '#3880ff', strokeWeight: 5 }"
          ></map-polyline>

          <map-marker
            *ngIf="truckPosition"
            [position]="truckPosition"
            [title]="'UbicaciÃ³n Actual: ' + (data.currentTemp || '') + 'Â°C'"
          ></map-marker>

        </google-map>

        <div *ngIf="!apiLoaded()" class="map-loading">
          <div class="spinner-small"></div>
          <p>Cargando mapa...</p>
        </div>

      </div>
    </div>

    <div class="card history-card">
      <h3>Historial TÃ©rmico</h3>
      <div class="chart-container">
        <div class="chart-bars">
          <div
            class="bar-wrapper"
            *ngFor="let item of data.telemetry"
            [title]="(item.timestamp | date:'shortTime') + ': ' + item.temperature + 'Â°C'"
          >
            <div
              class="bar"
              [style.height]="getBarHeight(item.temperature)"
              [style.background-color]="getTempColor(item.temperature)"
            ></div>
            <span class="bar-label">{{ item.temperature | number:'1.0-0' }}Â°</span>
          </div>

          <div *ngIf="!data.telemetry?.length" class="no-data">
            Esperando datos...
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<dialog #deliveryDialog class="delivery-modal">
  <form [formGroup]="deliveryForm" (ngSubmit)="onDeliverySubmit()">
    <h3>ğŸ“‹ Confirmar Entrega</h3>
    <p>Por favor ingrese los datos de recepciÃ³n.</p>

    <div class="form-group">
      <label>Firma / Nombre del Receptor</label>
      <input type="text" formControlName="recipientSignature" placeholder="Ej: Dr. Juan PÃ©rez">
    </div>

    <div class="form-group">
      <label>Notas (Opcional)</label>
      <textarea formControlName="notes" rows="3" placeholder="Estado del paquete, observaciones..."></textarea>
    </div>

    <div class="modal-actions">
      <button type="button" class="btn-cancel" (click)="closeDeliveryModal()">Cancelar</button>
      <button type="submit" class="btn-confirm" [disabled]="deliveryForm.invalid">Confirmar</button>
    </div>
  </form>
</dialog>

<div *ngIf="isLoading()" class="loading-overlay">
  <div class="spinner"></div>
</div>
